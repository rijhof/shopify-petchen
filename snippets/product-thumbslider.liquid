<div class="product-thumbslider" role="region" aria-label="Product images">
    <!-- Main Swiper -->
    <div class="thumbslider-main">
        <div class="swiper">
            <div class="swiper-wrapper">
                {% for media in product.media %}
                    <div class="swiper-slide thumbslider-main-slide" data-media-id="{{ media.id }}">
                        {% case media.media_type %}
                            {% when 'image' %}
                                <img src="{{ media | img_url: '800x' }}"
                                     alt="{{ media.alt | escape }}"
                                     width="800"
                                     height="{{ 800 | divided_by: media.aspect_ratio | round }}"
                                     loading="{% if forloop.first %}eager{% else %}lazy{% endif %}">
                            {% when 'video' %}
                                {{ media | video_tag: controls: true, muted: true, loop: true }}
                            {% when 'external_video' %}
                                {{ media | external_video_tag }}
                            {% when 'model' %}
                                {{ media | model_viewer_tag }}
                        {% endcase %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% if product.media.size > 1 %}
        <!-- Thumbnail Swiper -->
        <div class="swiper thumbslider-nav">
            <div class="swiper-wrapper">
                {% for media in product.media %}
                    <div class="swiper-slide thumbslider-nav-slide" data-media-id="{{ media.id }}">
                        {% case media.media_type %}
                            {% when 'image' %}
                                <img src="{{ media | img_url: '600x600' }}"
                                     alt="View {{ media.alt | default: product.title }} - Image {{ forloop.index }}"
                                     width="600"
                                     height="600"
                                     loading="lazy">
                            {% when 'video' %}
                                <div class="thumbslider-nav-video">
                                    <img src="{{ media.preview_image | img_url: '600x600' }}"
                                         alt="Play video - {{ product.title }}"
                                         width="600"
                                         height="600"
                                         loading="lazy">
                                    <span class="thumbslider-nav-video-icon" aria-hidden="true">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </span>
                                </div>
                            {% when 'external_video' %}
                                <div class="thumbslider-nav-video">
                                    <div class="thumbslider-nav-placeholder"></div>
                                    <span class="thumbslider-nav-video-icon" aria-hidden="true">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </span>
                                </div>
                            {% when 'model' %}
                                <div class="thumbslider-nav-model">
                                    <img src="{{ media.preview_image | img_url: '600x600' }}"
                                         alt="View 3D model - {{ product.title }}"
                                         width="600"
                                         height="600"
                                         loading="lazy">
                                    <span class="thumbslider-nav-model-icon" aria-hidden="true">3D</span>
                                </div>
                        {% endcase %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<style>
    .product-thumbslider {
        position: relative;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }

    .thumbslider-main {
        width: 100%;
        max-width: 100%;
        height: 0;
        padding-bottom: 100%;
        background: #f8f8f8;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    .thumbslider-main .swiper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .thumbslider-main .swiper-wrapper {
        width: 100%;
        height: 100%;
    }

    .thumbslider-main .swiper-slide {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-background-three);
        overflow: hidden;
    }

    .thumbslider-main img,
    .thumbslider-main video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: block;
    }

    .thumbslider-main model-viewer {
        width: 100%;
        height: 100%;
    }

    .thumbslider-nav {
        margin-top: 32px;
        width: 100%;
    }

    .thumbslider-nav .swiper-slide {
        width: calc(25% - 7.5px) !important;
        height: 0;
        padding-bottom: calc(25% - 7.5px);
        position: relative;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        flex-shrink: 0;
        opacity: 1 !important;
    }

    .thumbslider-nav .swiper-slide-thumb-active {
        border-color: #000;
    }

    .thumbslider-nav .swiper-slide:hover {
        border-color: #666;
    }

    .thumbslider-nav img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }

    .thumbslider-nav-video,
    .thumbslider-nav-model {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .thumbslider-nav-placeholder {
        width: 100%;
        height: 100%;
        background: #e0e0e0;
    }

    .thumbslider-nav-video-icon,
    .thumbslider-nav-model-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        color: #000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        pointer-events: none;
    }

    .thumbslider-nav-video-icon svg {
        display: block;
        width: 20px;
        height: 20px;
    }

    .thumbslider-main .swiper {
        width: 100%;
        height: 100%;
    }

    .thumbslider-main .swiper-slide {
        text-align: center;
        font-size: 18px;
        background: var(--color-background-two);
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
    }

    .thumbslider-nav .swiper-wrapper {
        align-items: stretch;
    }

    .swiper {
        overflow: hidden !important;
    }

    .swiper-slide img {
        display: block;
        background: var(--color-background-two);
        max-width: 100% !important;
    }

    .thumbslider-main .swiper-slide-active {
        width: 100% !important;
    }

    .thumbslider-main .swiper-wrapper {
        align-items: center;
    }

    @media (max-width: 480px) {
        .thumbslider-nav .swiper-slide {
            width: calc(25% - 6px) !important;
            padding-bottom: calc(25% - 6px);
        }

        .thumbslider-nav-video-icon,
        .thumbslider-nav-model-icon {
            font-size: 9px;
            padding: 3px 5px;
        }

        .thumbslider-nav-video-icon svg {
            width: 14px;
            height: 14px;
        }
    }

    @media (min-width: 481px) and (max-width: 767px) {
        .thumbslider-nav .swiper-slide {
            width: calc(25% - 7.5px) !important;
            padding-bottom: calc(25% - 7.5px);
        }

        .thumbslider-nav-video-icon,
        .thumbslider-nav-model-icon {
            font-size: 10px;
            padding: 4px 6px;
        }

        .thumbslider-nav-video-icon svg {
            width: 16px;
            height: 16px;
        }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
        .product-thumbslider {
            max-width: 500px;
        }

        .thumbslider-nav .swiper-slide {
            width: calc(25% - 7.5px) !important;
            padding-bottom: calc(25% - 7.5px);
        }
    }

    @media (min-width: 1440px) {
        .product-thumbslider {
            max-width: 700px;
        }

        .thumbslider-nav .swiper-slide {
            width: calc(25% - 7.5px) !important;
            padding-bottom: calc(25% - 7.5px);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Swiper === 'undefined') {
            console.error('Swiper.js ist nicht geladen');
            return;
        }

        const thumbsSwiper = new Swiper('.thumbslider-nav', {
            spaceBetween: 10,
            slidesPerView: 4,
            freeMode: false,
            watchSlidesProgress: true,
            allowTouchMove: true,
            breakpoints: {
                0: {
                    spaceBetween: 8,
                    slidesPerView: 4
                },
                481: {
                    spaceBetween: 10,
                    slidesPerView: 4
                },
                768: {
                    spaceBetween: 10,
                    slidesPerView: 4
                },
                1024: {
                    spaceBetween: 10,
                    slidesPerView: 4
                }
            },
            centerInsufficientSlides: false,
            centeredSlides: false,
            loop: false,
            loopFillGroupWithBlank: false
        });

        const mainSwiper = new Swiper('.thumbslider-main .swiper', {
            spaceBetween: 0,
            slidesPerView: 1,
            thumbs: {
                swiper: thumbsSwiper
            },
            autoHeight: false,
            touchEventsTarget: 'container',
            grabCursor: true,
            watchOverflow: true,
            centerInsufficientSlides: true,
            observer: true,
            observeParents: true,
            lazy: {
                loadPrevNext: true,
            },
            a11y: {
                enabled: true,
                prevSlideMessage: 'Vorheriges Bild',
                nextSlideMessage: 'Nächstes Bild',
                firstSlideMessage: 'Dies ist das erste Bild',
                lastSlideMessage: 'Dies ist das letzte Bild'
            }
        });

        mainSwiper.keyboard = {
            enabled: true,
            onlyInViewport: true
        };

        mainSwiper.on('slideChange', function() {
            const videos = document.querySelectorAll('.thumbslider-main video');
            videos.forEach(video => {
                if (video) video.pause();
            });

            const activeSlide = mainSwiper.slides[mainSwiper.activeIndex];
            const activeVideo = activeSlide?.querySelector('video');
            if (activeVideo && activeVideo.hasAttribute('autoplay')) {
                activeVideo.play();
            }
        });

        setTimeout(() => {
            mainSwiper.update();
            thumbsSwiper.update();

            const visibleSlides = document.querySelectorAll('.thumbslider-nav .swiper-slide');
            console.log(`Anzahl Thumbnail-Slides: ${visibleSlides.length}`);

            visibleSlides.forEach((slide, index) => {
                slide.style.width = 'calc(25% - 7.5px)';
                slide.style.flexShrink = '0';
            });
        }, 100);

        window.addEventListener('resize', function() {
            setTimeout(() => {
                thumbsSwiper.update();
                mainSwiper.update();
            }, 100);
        });
    });
</script>